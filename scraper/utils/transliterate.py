"""
Транслитератор персидской арабицы в таджикскую кириллицу

Улучшенная версия v2 с расширенным словарём (500+ слов)
и улучшенными правилами для восстановления гласных.
"""

import re
from typing import Optional
import json
from pathlib import Path


class PersianToTajikTransliterator:
    """
    Контекстно-зависимая транслитерация персидского текста в таджикский.
    """

    # Согласные
    CONSONANTS = {
        'ب': 'б', 'پ': 'п', 'ت': 'т', 'ث': 'с',
        'ج': 'ҷ', 'چ': 'ч', 'ح': 'ҳ', 'خ': 'х',
        'د': 'д', 'ذ': 'з', 'ر': 'р', 'ز': 'з',
        'ژ': 'ж', 'س': 'с', 'ش': 'ш', 'ص': 'с',
        'ض': 'з', 'ط': 'т', 'ظ': 'з', 'ع': 'ъ',
        'غ': 'ғ', 'ف': 'ф', 'ق': 'қ', 'ک': 'к',
        'ك': 'к', 'گ': 'г', 'ل': 'л', 'م': 'м',
        'ن': 'н', 'ه': 'ҳ', 'ی': 'й', 'ي': 'й',
        'ء': 'ъ',
    }

    CONSONANTS_SET = set(CONSONANTS.values())
    VOWELS_SET = {'а', 'е', 'и', 'о', 'у', 'ӣ', 'ӯ', 'э', 'ё'}

    # Диакритические знаки
    DIACRITICS = {
        'َ': 'а', 'ِ': 'и', 'ُ': 'у',
        'ّ': '', 'ْ': '',
        'ً': 'ан', 'ٍ': 'ин', 'ٌ': 'ун',
        'ٔ': '',  # hamza above
        'ٕ': '',  # hamza below
    }

    # ============================================================
    # РАСШИРЕННЫЙ СЛОВАРЬ (500+ слов)
    # ============================================================
    WORD_DICTIONARY = {
        # === МЕСТОИМЕНИЯ ===
        'من': 'ман', 'تو': 'ту', 'او': 'ӯ', 'ما': 'мо',
        'شما': 'шумо', 'ایشان': 'эшон', 'این': 'ин',
        'آن': 'он', 'چه': 'чӣ', 'که': 'ки', 'کی': 'кӣ',
        'چی': 'чӣ', 'هر': 'ҳар', 'همه': 'ҳама', 'خود': 'худ',
        'خویش': 'хеш', 'وی': 'вай', 'ایشان': 'эшон',
        'کس': 'кас', 'هیچکس': 'ҳеҷ кас', 'همین': 'ҳамин',
        'همان': 'ҳамон', 'چنین': 'чунин', 'چنان': 'чунон',
        'کدام': 'кадом', 'چیست': 'чист', 'کیست': 'кист',

        # === ГЛАГОЛЫ - БЫТИЙНЫЕ ===
        'است': 'аст', 'هست': 'ҳаст', 'نیست': 'нест',
        'بود': 'буд', 'نبود': 'набуд', 'باشد': 'бошад',
        'باشم': 'бошам', 'باشی': 'бошӣ', 'باشند': 'бошанд',
        'بودم': 'будам', 'بودی': 'будӣ', 'بودند': 'буданд',
        'هستم': 'ҳастам', 'هستی': 'ҳастӣ', 'هستند': 'ҳастанд',
        'نیستم': 'нестам', 'نیستی': 'нестӣ',

        # === ГЛАГОЛЫ - ШУДАН (становиться) ===
        'شد': 'шуд', 'نشد': 'нашуд', 'شود': 'шавад',
        'شوم': 'шавам', 'شوی': 'шавӣ', 'شوند': 'шаванд',
        'شدم': 'шудам', 'شدی': 'шудӣ', 'شدند': 'шуданд',
        'میشود': 'мешавад', 'نمیشود': 'намешавад',
        'شده': 'шуда', 'نشده': 'нашуда',

        # === ГЛАГОЛЫ - КАРДАН (делать) ===
        'کرد': 'кард', 'نکرد': 'накард', 'کند': 'кунад',
        'کنم': 'кунам', 'کنی': 'кунӣ', 'کنند': 'кунанд',
        'کردم': 'кардам', 'کردی': 'кардӣ', 'کردند': 'карданд',
        'میکند': 'мекунад', 'نمیکند': 'намекунад',
        'کرده': 'карда', 'بکن': 'бикун', 'مکن': 'макун',

        # === ГЛАГОЛЫ - ГУФТАН (говорить) ===
        'گفت': 'гуфт', 'گوید': 'гӯяд', 'گویم': 'гӯям',
        'گویی': 'гӯӣ', 'گویند': 'гӯянд',
        'گفتم': 'гуфтам', 'گفتی': 'гуфтӣ', 'گفتند': 'гуфтанд',
        'میگوید': 'мегӯяд', 'گفته': 'гуфта', 'بگو': 'бигӯ',

        # === ГЛАГОЛЫ - ОМАДАН (приходить) ===
        'آمد': 'омад', 'آید': 'ояд', 'آیم': 'оям',
        'آیی': 'оӣ', 'آیند': 'оянд',
        'آمدم': 'омадам', 'آمدی': 'омадӣ', 'آمدند': 'омаданд',
        'میآید': 'меояд', 'نمیآید': 'намеояд',
        'آمده': 'омада', 'بیا': 'биё', 'بیایید': 'биёед',

        # === ГЛАГОЛЫ - РАФТАН (идти) ===
        'رفت': 'рафт', 'رود': 'равад', 'روم': 'равам',
        'روی': 'равӣ', 'روند': 'раванд',
        'رفتم': 'рафтам', 'رفتی': 'рафтӣ', 'رفتند': 'рафтанд',
        'میرود': 'меравад', 'نمیرود': 'намеравад',
        'رفته': 'рафта', 'برو': 'бирав', 'نرو': 'нарав',

        # === ГЛАГОЛЫ - ДИДАН (видеть) ===
        'دید': 'дид', 'بیند': 'бинад', 'بینم': 'бинам',
        'بینی': 'бинӣ', 'بینند': 'бинанд',
        'دیدم': 'дидам', 'دیدی': 'дидӣ', 'دیدند': 'диданд',
        'میبیند': 'мебинад', 'دیده': 'дида', 'ببین': 'бибин',

        # === ГЛАГОЛЫ - ДОДАН (давать) ===
        'داد': 'дод', 'دهد': 'диҳад', 'دهم': 'диҳам',
        'دهی': 'диҳӣ', 'دهند': 'диҳанд',
        'دادم': 'додам', 'دادی': 'додӣ', 'دادند': 'доданд',
        'میدهد': 'медиҳад', 'داده': 'дода', 'بده': 'бидеҳ',

        # === ГЛАГОЛЫ - ЗАДАН (бить) ===
        'زد': 'зад', 'زند': 'занад', 'زنم': 'занам',
        'زدم': 'задам', 'زدی': 'задӣ', 'زدند': 'заданд',
        'میزند': 'мезанад', 'زده': 'зада', 'بزن': 'бизан',

        # === ГЛАГОЛЫ - ХӮРДАН (есть) ===
        'خورد': 'хӯрд', 'خورد': 'хӯрад', 'خورم': 'хӯрам',
        'خوردم': 'хӯрдам', 'خوردی': 'хӯрдӣ',
        'میخورد': 'мехӯрад', 'خورده': 'хӯрда', 'بخور': 'бихӯр',

        # === ГЛАГОЛЫ - БУРДАН (нести) ===
        'برد': 'бурд', 'برد': 'барад', 'برم': 'барам',
        'بردم': 'бурдам', 'بردی': 'бурдӣ', 'بردند': 'бурданд',
        'میبرد': 'мебарад', 'برده': 'бурда', 'ببر': 'бибар',

        # === ГЛАГОЛЫ - ОВАРДАН (приносить) ===
        'آورد': 'овард', 'آورد': 'оварад', 'آورم': 'оварам',
        'آوردم': 'овардам', 'آوردی': 'овардӣ',
        'میآورد': 'меоварад', 'آورده': 'оварда', 'بیاور': 'биёвар',

        # === ГЛАГОЛЫ - МОНДАН (оставаться) ===
        'ماند': 'монд', 'ماند': 'монад', 'مانم': 'монам',
        'ماندم': 'мондам', 'ماندی': 'мондӣ',
        'میماند': 'мемонад', 'مانده': 'монда', 'بمان': 'бимон',

        # === ГЛАГОЛЫ - НИШАСТАН (сидеть) ===
        'نشست': 'нишаст', 'نشیند': 'нишинад', 'نشینم': 'нишинам',
        'نشستم': 'нишастам', 'نشسته': 'нишаста', 'بنشین': 'бинишин',

        # === ГЛАГОЛЫ - ХОСТАН (хотеть) ===
        'خواست': 'хост', 'خواهد': 'хоҳад', 'خواهم': 'хоҳам',
        'خواهی': 'хоҳӣ', 'خواهند': 'хоҳанд',
        'خواستم': 'хостам', 'میخواهد': 'мехоҳад',
        'خواسته': 'хоста', 'بخواه': 'бихоҳ',

        # === ГЛАГОЛЫ - ДОНИСТАН (знать) ===
        'دانست': 'донист', 'داند': 'донад', 'دانم': 'донам',
        'دانی': 'донӣ', 'دانند': 'донанд',
        'دانستم': 'донистам', 'میداند': 'медонад',
        'دانسته': 'дониста', 'بدان': 'бидон',

        # === ГЛАГОЛЫ - ТАВОНИСТАН (мочь) ===
        'توانست': 'тавонист', 'تواند': 'тавонад', 'توانم': 'тавонам',
        'توانی': 'тавонӣ', 'توانند': 'тавонанд',
        'میتواند': 'метавонад', 'توانسته': 'тавониста',

        # === ГЛАГОЛЫ - ГУЗОШТАН (ставить) ===
        'گذاشت': 'гузошт', 'گذارد': 'гузорад', 'گذارم': 'гузорам',
        'گذاشتم': 'гузоштам', 'میگذارد': 'мегузорад',
        'گذاشته': 'гузошта', 'بگذار': 'бигузор',

        # === ГЛАГОЛЫ - НАВИШТАН (писать) ===
        'نوشت': 'навишт', 'نویسد': 'нависад', 'نویسم': 'нависам',
        'نوشتم': 'навиштам', 'مینویسد': 'менависад',
        'نوشته': 'навишта', 'بنویس': 'бинавис',

        # === ГЛАГОЛЫ - ХОНДАН (читать/звать) ===
        'خواند': 'хонд', 'خواند': 'хонад', 'خوانم': 'хонам',
        'خواندم': 'хондам', 'میخواند': 'мехонад',
        'خوانده': 'хонда', 'بخوان': 'бихон',

        # === ГЛАГОЛЫ - АФТОДАН (падать) ===
        'افتاد': 'афтод', 'افتد': 'афтад', 'افتم': 'афтам',
        'افتادم': 'афтодам', 'میافتد': 'меафтад',
        'افتاده': 'афтода',

        # === ГЛАГОЛЫ - РЕХТАН (лить) ===
        'ریخت': 'рехт', 'ریزد': 'резад', 'ریزم': 'резам',
        'ریختم': 'рехтам', 'میریزد': 'мерезад',
        'ریخته': 'рехта', 'بریز': 'бирез',

        # === ГЛАГОЛЫ - СӮХТАН (гореть) ===
        'سوخت': 'сӯхт', 'سوزد': 'сӯзад', 'سوزم': 'сӯзам',
        'سوختم': 'сӯхтам', 'میسوزد': 'месӯзад',
        'سوخته': 'сӯхта', 'بسوز': 'бисӯз',

        # === ГЛАГОЛЫ - СОХТАН (делать/строить) ===
        'ساخت': 'сохт', 'سازد': 'созад', 'سازم': 'созам',
        'ساختم': 'сохтам', 'میسازد': 'месозад',
        'ساخته': 'сохта', 'بساز': 'бисоз',

        # === ГЛАГОЛЫ - ЁФТАН (находить) ===
        'یافت': 'ёфт', 'یابد': 'ёбад', 'یابم': 'ёбам',
        'یافتم': 'ёфтам', 'مییابد': 'меёбад',
        'یافته': 'ёфта', 'بیاب': 'биёб',

        # === ГЛАГОЛЫ - ШУНИДАН (слышать) ===
        'شنید': 'шунид', 'شنود': 'шунавад', 'شنوم': 'шунавам',
        'شنیدم': 'шунидам', 'میشنود': 'мешунавад',
        'شنیده': 'шунида', 'بشنو': 'бишунав',

        # === ГЛАГОЛЫ - ГИРИФТАН (брать) ===
        'گرفت': 'гирифт', 'گیرد': 'гирад', 'گیرم': 'гирам',
        'گرفتم': 'гирифтам', 'میگیرد': 'мегирад',
        'گرفته': 'гирифта', 'بگیر': 'бигир',

        # === ГЛАГОЛЫ - КАШИДАН (тянуть) ===
        'کشید': 'кашид', 'کشد': 'кашад', 'کشم': 'кашам',
        'کشیدم': 'кашидам', 'میکشد': 'мекашад',
        'کشیده': 'кашида', 'بکش': 'бикаш',

        # === ГЛАГОЛЫ - ПУРСИДАН (спрашивать) ===
        'پرسید': 'пурсид', 'پرسد': 'пурсад', 'پرسم': 'пурсам',
        'پرسیدم': 'пурсидам', 'میپرسد': 'мепурсад',
        'پرسیده': 'пурсида', 'بپرس': 'бипурс',

        # === ГЛАГОЛЫ - РАСИДАН (достигать) ===
        'رسید': 'расид', 'رسد': 'расад', 'رسم': 'расам',
        'رسیدم': 'расидам', 'میرسد': 'мерасад',
        'رسیده': 'расида', 'برس': 'бирас',

        # === ГЛАГОЛЫ - ХОНДАН/ФАҲМИДАН ===
        'فهمید': 'фаҳмид', 'فهمد': 'фаҳмад', 'فهمم': 'фаҳмам',
        'فهمیدم': 'фаҳмидам', 'میفهمد': 'мефаҳмад',
        'فهمیده': 'фаҳмида',

        # === ГЛАГОЛЫ - ИСТОДАН (стоять) ===
        'ایستاد': 'истод', 'ایستد': 'истад', 'ایستم': 'истам',
        'ایستادم': 'истодам', 'میایستد': 'меистад',
        'ایستاده': 'истода', 'بایست': 'биист',

        # === ГЛАГОЛЫ - ФУРӮХТАН (продавать) ===
        'فروخت': 'фурӯхт', 'فروشد': 'фурӯшад',
        'میفروشد': 'мефурӯшад', 'فروخته': 'фурӯхта',

        # === ГЛАГОЛЫ - ХАРИДАН (покупать) ===
        'خرید': 'харид', 'خرد': 'харад',
        'میخرد': 'мехарад', 'خریده': 'харида',

        # === ГЛАГОЛЫ - ЗАДОЛНИТЕЛЬНЫЕ ===
        'بخشید': 'бахшид', 'ببخش': 'бибахш',
        'سپرد': 'супурд', 'سپارد': 'супорад',
        'افروخت': 'афрӯхт', 'افروزد': 'афрӯзад',
        'اندیشید': 'андешид', 'اندیشد': 'андешад',
        'پوشید': 'пӯшид', 'پوشد': 'пӯшад',
        'جست': 'ҷуст', 'جوید': 'ҷӯяд',
        'نشان': 'нишон', 'دهد': 'диҳад',

        # === ПРЕФИКС МЕ- (настоящее время) ===
        'می': 'ме', 'نمی': 'наме', 'همی': 'ҳаме',

        # === ТЕЛО ЧЕЛОВЕКА ===
        'سر': 'сар', 'دل': 'дил', 'جان': 'ҷон', 'تن': 'тан',
        'چشم': 'чашм', 'دست': 'даст', 'پا': 'по', 'پای': 'пой',
        'رو': 'рӯ', 'روی': 'рӯй', 'رخ': 'рух', 'لب': 'лаб',
        'زلف': 'зулф', 'مو': 'мӯ', 'موی': 'мӯй', 'ابرو': 'абрӯ',
        'گوش': 'гӯш', 'بینی': 'бинӣ', 'دهان': 'даҳон',
        'زبان': 'забон', 'دندان': 'дандон', 'گردن': 'гардан',
        'سینه': 'сина', 'قلب': 'қалб', 'جگر': 'ҷигар',
        'خون': 'хун', 'اشک': 'ашк', 'آه': 'оҳ',
        'دیده': 'дида', 'مژه': 'мижа', 'ابرو': 'абрӯ',
        'گیسو': 'гесу', 'انگشت': 'ангушт', 'ناخن': 'нохун',
        'پشت': 'пушт', 'شکم': 'шикам', 'کمر': 'камар',
        'ران': 'рон', 'زانو': 'зону', 'پنجه': 'панҷа',
        'مشت': 'мушт', 'بازو': 'бозу', 'شانه': 'шона',
        'گونه': 'гуна', 'پیشانی': 'пешонӣ', 'چانه': 'чона',
        'گلو': 'гулӯ', 'حلق': 'ҳалқ', 'نفس': 'нафас',
        'روح': 'рӯҳ', 'عقل': 'ақл', 'هوش': 'ҳуш',

        # === ПРИРОДА ===
        'آب': 'об', 'آتش': 'оташ', 'باد': 'бод', 'خاک': 'хок',
        'آسمان': 'осмон', 'زمین': 'замин', 'خورشید': 'хуршед',
        'ماه': 'моҳ', 'ستاره': 'ситора', 'ابر': 'абр',
        'باران': 'борон', 'برف': 'барф', 'گل': 'гул',
        'درخت': 'дарахт', 'برگ': 'барг', 'میوه': 'мева',
        'باغ': 'боғ', 'بوستان': 'бӯстон', 'گلستان': 'гулистон',
        'چمن': 'чаман', 'صحرا': 'саҳро', 'دشت': 'дашт',
        'کوه': 'кӯҳ', 'دریا': 'дарё', 'رود': 'руд',
        'جوی': 'ҷӯй', 'چشمه': 'чашма', 'سنگ': 'санг',
        'بهار': 'баҳор', 'تابستان': 'тобистон',
        'پاییز': 'тирамоҳ', 'زمستان': 'зимистон',
        'صبح': 'субҳ', 'شب': 'шаб', 'روز': 'рӯз',
        'شام': 'шом', 'سحر': 'саҳар', 'فجر': 'фаҷр',
        'شفق': 'шафақ', 'غروب': 'ғуруб', 'طلوع': 'тулӯъ',
        'نور': 'нур', 'ظلمت': 'зулмат', 'تاریک': 'торик',
        'روشن': 'равшан', 'تابان': 'тобон', 'درخشان': 'дурахшон',
        'سایه': 'соя', 'شعاع': 'шуоъ', 'پرتو': 'партав',
        'رعد': 'раъд', 'برق': 'барқ', 'صاعقه': 'соиқа',
        'طوفان': 'тӯфон', 'سیل': 'сел', 'موج': 'мавҷ',
        'ساحل': 'соҳил', 'جزیره': 'ҷазира', 'اقیانوس': 'уқёнус',
        'جنگل': 'ҷангал', 'بیابان': 'биёбон', 'واحه': 'воҳа',
        'گیاه': 'гиёҳ', 'بوته': 'бута', 'ریشه': 'реша',
        'شاخه': 'шоха', 'ساقه': 'соқа', 'غنچه': 'ғунча',
        'شکوفه': 'шукуфа', 'بید': 'бед', 'سرو': 'сарв',
        'نخل': 'нахл', 'انار': 'анор', 'سیب': 'себ',
        'انگور': 'ангур', 'لاله': 'лола', 'نرگس': 'наргис',
        'سنبل': 'сунбул', 'یاسمین': 'ёсуман', 'بنفشه': 'банафша',
        'سوسن': 'савсан', 'ریحان': 'райҳон',

        # === АБСТРАКТНЫЕ ПОНЯТИЯ ===
        'عشق': 'ишқ', 'مهر': 'меҳр', 'محبت': 'муҳаббат',
        'دوست': 'дӯст', 'دوستی': 'дӯстӣ', 'یار': 'ёр',
        'عمر': 'умр', 'زندگی': 'зиндагӣ', 'مرگ': 'марг',
        'غم': 'ғам', 'درد': 'дард', 'رنج': 'ранҷ',
        'شادی': 'шодӣ', 'خوشی': 'хушӣ', 'لذت': 'лаззат',
        'امید': 'умед', 'آرزو': 'орзу', 'خیال': 'хаёл',
        'فکر': 'фикр', 'علم': 'илм', 'حکمت': 'ҳикмат',
        'راز': 'роз', 'سر': 'сирр', 'حقیقت': 'ҳақиқат',
        'نام': 'ном', 'کار': 'кор', 'راه': 'роҳ',
        'سخن': 'сухан', 'کلام': 'калом', 'حرف': 'ҳарф',
        'وقت': 'вақт', 'زمان': 'замон', 'دم': 'дам',
        'جهان': 'ҷаҳон', 'دنیا': 'дунё', 'عالم': 'олам',
        'ملک': 'мулк', 'شهر': 'шаҳр', 'خانه': 'хона',
        'دروازه': 'дарвоза', 'بام': 'бом',
        'حال': 'ҳол', 'احوال': 'аҳвол', 'حالت': 'ҳолат',
        'معنی': 'маънӣ', 'مفهوم': 'мафҳум', 'تفسیر': 'тафсир',
        'باور': 'бовар', 'یقین': 'яқин', 'شک': 'шак',
        'خاطر': 'хотир', 'یاد': 'ёд', 'فراموش': 'фаромӯш',
        'صبر': 'сабр', 'تحمل': 'таҳаммул', 'شکیب': 'шакеб',
        'عزت': 'иззат', 'افتخار': 'ифтихор', 'شرف': 'шараф',
        'حیا': 'ҳаё', 'شرم': 'шарм', 'عیب': 'айб',
        'گناه': 'гуноҳ', 'ثواب': 'савоб', 'عذاب': 'азоб',
        'بهشت': 'биҳишт', 'جنت': 'ҷаннат', 'دوزخ': 'дӯзах',
        'جهنم': 'ҷаҳаннам', 'فردوس': 'фирдавс',
        'صلح': 'сулҳ', 'جنگ': 'ҷанг', 'غلبه': 'ғалаба',
        'شکست': 'шикаст', 'پیروزی': 'пирӯзӣ', 'فتح': 'фатҳ',
        'ظلم': 'зулм', 'عدل': 'адл', 'انصاف': 'инсоф',
        'حق': 'ҳақ', 'باطل': 'ботил', 'صدق': 'сидқ',
        'دروغ': 'дурӯғ', 'راست': 'рост', 'کج': 'каҷ',

        # === ПОЭТИЧЕСКАЯ ЛЕКСИКА ===
        'شعر': 'шеър', 'بیت': 'байт', 'مصرع': 'мисраъ',
        'رباعی': 'рубоӣ', 'غزل': 'ғазал', 'قصیده': 'қасида',
        'مثنوی': 'маснавӣ', 'قطعه': 'қитъа',
        'شاعر': 'шоир', 'سخنور': 'суханвар',
        'بلبل': 'булбул', 'صبا': 'сабо', 'نسیم': 'насим',
        'شراب': 'шароб', 'باده': 'бода',
        'ساقی': 'соқӣ', 'مستی': 'мастӣ', 'مست': 'маст',
        'جام': 'ҷом', 'پیاله': 'пиёла', 'ساغر': 'соғар',
        'مطرب': 'мутриб', 'چنگ': 'чанг', 'نی': 'най',
        'رقص': 'рақс', 'سماع': 'самоъ',
        'قافیه': 'қофия', 'ردیف': 'радиф', 'وزن': 'вазн',
        'عروض': 'арӯз', 'محبوب': 'маҳбуб', 'معشوق': 'маъшуқ',
        'عاشق': 'ошиқ', 'دلبر': 'дилбар', 'جانان': 'ҷонон',
        'نگار': 'нигор', 'بت': 'бут', 'صنم': 'санам',
        'پری': 'парӣ', 'حور': 'ҳур', 'فرشته': 'фаришта',
        'ملک': 'малак', 'شمع': 'шамъ', 'پروانه': 'парвона',
        'قفس': 'қафас', 'مرغ': 'мурғ', 'پرنده': 'паранда',
        'بال': 'бол', 'پر': 'пар', 'آشیان': 'ошён',
        'گنج': 'ганҷ', 'خزانه': 'хазина', 'گوهر': 'гавҳар',
        'لعل': 'лаъл', 'یاقوت': 'ёқут', 'مروارید': 'марворид',
        'الماس': 'алмос', 'زمرد': 'зумуррад', 'طلا': 'тилло',
        'نقره': 'нуқра', 'زر': 'зар', 'سیم': 'сим',
        'آینه': 'оина', 'حجاب': 'ҳиҷоб', 'پرده': 'парда',

        # === ПРИЛАГАТЕЛЬНЫЕ ===
        'خوب': 'хуб', 'بد': 'бад', 'نیک': 'нек',
        'زیبا': 'зебо', 'خوش': 'хуш', 'شیرین': 'ширин',
        'تلخ': 'талх', 'سرد': 'сард', 'گرم': 'гарм',
        'بزرگ': 'бузург', 'کوچک': 'хурд', 'خرد': 'хурд',
        'نو': 'нав', 'کهن': 'куҳан', 'پیر': 'пир',
        'جوان': 'ҷавон', 'تازه': 'тоза', 'کهنه': 'кӯҳна',
        'سپید': 'сафед', 'سیاه': 'сиёҳ', 'سرخ': 'сурх',
        'سبز': 'сабз', 'زرد': 'зард', 'آبی': 'обӣ',
        'بلند': 'баланд', 'کوتاه': 'кӯтоҳ', 'دراز': 'дароз',
        'پر': 'пур', 'خالی': 'холӣ', 'تنها': 'танҳо',
        'دور': 'дур', 'نزدیک': 'наздик', 'پیش': 'пеш',
        'بالا': 'боло', 'پایین': 'поён', 'عجب': 'аҷаб',
        'شاد': 'шод', 'غمگین': 'ғамгин', 'خسته': 'хаста',
        'بیمار': 'бемор', 'سالم': 'солим', 'زنده': 'зинда',
        'مرده': 'мурда', 'قوی': 'қавӣ', 'ضعیف': 'заиф',
        'سخت': 'сахт', 'نرم': 'нарм', 'تیز': 'тез',
        'کند': 'кунд', 'روشن': 'равшан', 'تاریک': 'торик',
        'زشت': 'зишт', 'خوشگل': 'хушгил',
        'راست': 'рост', 'چپ': 'чап', 'مستقیم': 'мустақим',
        'پاک': 'пок', 'ناپاک': 'нопок', 'کثیف': 'касиф',
        'خشک': 'хушк', 'تر': 'тар', 'مرطوب': 'мартуб',
        'ثابت': 'собит', 'متحرک': 'мутаҳаррик',
        'ساکت': 'сокит', 'آرام': 'ором', 'شلوغ': 'шулуғ',
        'عجیب': 'аҷиб', 'غریب': 'ғариб', 'نادر': 'нодир',

        # === СОЮЗЫ И ЧАСТИЦЫ ===
        'و': 'ва', 'که': 'ки', 'اگر': 'агар', 'گر': 'гар',
        'چون': 'чун', 'چو': 'чу', 'تا': 'то', 'را': 'ро',
        'از': 'аз', 'به': 'ба', 'در': 'дар', 'با': 'бо',
        'بر': 'бар', 'زیر': 'зер', 'پس': 'пас',
        'هم': 'ҳам', 'نه': 'на', 'نی': 'не', 'یا': 'ё',
        'ولی': 'вале', 'اما': 'аммо', 'لیک': 'лек',
        'باز': 'боз', 'هنوز': 'ҳанӯз',
        'چرا': 'чаро', 'کجا': 'куҷо', 'چگونه': 'чӣ гуна',
        'چند': 'чанд', 'هیچ': 'ҳеч', 'همچو': 'ҳамчу',
        'همچون': 'ҳамчун', 'مثل': 'мисли', 'مانند': 'монанд',
        'زیرا': 'зеро', 'چونکه': 'чунки', 'برای': 'барои',
        'مگر': 'магар', 'بلکه': 'балки', 'شاید': 'шояд',
        'البته': 'албатта', 'حتما': 'ҳатман', 'هرگز': 'ҳаргиз',
        'فقط': 'фақат', 'حتی': 'ҳатто', 'دیگر': 'дигар',
        'مثلا': 'масалан', 'یعنی': 'яъне', 'خاصه': 'хосса',

        # === ЧИСЛИТЕЛЬНЫЕ ===
        'یک': 'як', 'دو': 'ду', 'سه': 'се', 'چهار': 'чор',
        'پنج': 'панҷ', 'شش': 'шаш', 'هفت': 'ҳафт',
        'هشت': 'ҳашт', 'نه': 'нӯҳ', 'ده': 'даҳ',
        'یازده': 'ёздаҳ', 'دوازده': 'дувоздаҳ',
        'سیزده': 'сенздаҳ', 'چهارده': 'чордаҳ',
        'پانزده': 'понздаҳ', 'شانزده': 'шонздаҳ',
        'هفده': 'ҳабдаҳ', 'هجده': 'ҳаждаҳ',
        'نوزده': 'нуздаҳ', 'بیست': 'бист',
        'سی': 'сӣ', 'چهل': 'чил', 'پنجاه': 'панҷоҳ',
        'شصت': 'шаст', 'هفتاد': 'ҳафтод',
        'هشتاد': 'ҳаштод', 'نود': 'навад',
        'صد': 'сад', 'هزار': 'ҳазор', 'میلیون': 'миллион',
        'بسیار': 'бисёр', 'کم': 'кам', 'اندک': 'андак',
        'اول': 'аввал', 'دوم': 'дуюм', 'سوم': 'сеюм',
        'نیم': 'ним', 'نصف': 'нисф', 'ربع': 'рубъ',

        # === РЕЛИГИЯ И ФИЛОСОФИЯ ===
        'خدا': 'Худо', 'خداوند': 'Худованд', 'الله': 'Аллоҳ',
        'رب': 'Раб', 'پروردگار': 'Парвардигор',
        'بهشت': 'биҳишт', 'جنت': 'ҷаннат', 'دوزخ': 'дӯзах',
        'فرشته': 'фаришта', 'ملک': 'малак',
        'نماز': 'намоз', 'روزه': 'рӯза', 'دعا': 'дуъо',
        'توبه': 'тавба', 'گناه': 'гуноҳ', 'ثواب': 'савоб',
        'ایمان': 'имон', 'اسلام': 'ислом', 'مسلمان': 'мусулмон',
        'پیامبر': 'пайғамбар', 'رسول': 'расул', 'نبی': 'набӣ',
        'قرآن': 'Қуръон', 'کتاب': 'китоб', 'آیه': 'оят',
        'سوره': 'сура', 'حدیث': 'ҳадис', 'روایت': 'ривоят',
        'مسجد': 'масҷид', 'کعبه': 'Каъба', 'حج': 'ҳаҷ',
        'زکات': 'закот', 'صدقه': 'садақа', 'خیرات': 'хайрот',
        'وحدت': 'ваҳдат', 'کثرت': 'касрат', 'فنا': 'фано',
        'بقا': 'бақо', 'تجلی': 'таҷаллӣ', 'ظهور': 'зуҳур',

        # === ИМЕНА ПОЭТОВ ===
        'رودکی': 'Рӯдакӣ', 'فردوسی': 'Фирдавсӣ',
        'حافظ': 'Ҳофиз', 'سعدی': 'Саъдӣ', 'خیام': 'Хайём',
        'مولوی': 'Мавлавӣ', 'مولانا': 'Мавлоно', 'رومی': 'Румӣ',
        'جامی': 'Ҷомӣ', 'بیدل': 'Бедил', 'عطار': 'Аттор',
        'نظامی': 'Низомӣ', 'خاقانی': 'Хоқонӣ', 'انوری': 'Анварӣ',
        'سنایی': 'Саноӣ', 'فرخی': 'Фаррухӣ', 'عنصری': 'Унсурӣ',
        'منوچهری': 'Манучеҳрӣ', 'ناصرخسرو': 'Носирхусрав',

        # === ГЕОГРАФИЧЕСКИЕ НАЗВАНИЯ ===
        'ایران': 'Эрон', 'تاجیکستان': 'Тоҷикистон',
        'سمرقند': 'Самарқанд', 'بخارا': 'Бухоро',
        'شیراز': 'Шероз', 'اصفهان': 'Исфаҳон',
        'بلخ': 'Балх', 'هرات': 'Ҳирот', 'غزنه': 'Ғазна',
        'خراسان': 'Хуросон', 'ماوراءالنهر': 'Мовароуннаҳр',

        # === ВРЕМЯ ===
        'امروز': 'имрӯз', 'دیروز': 'дирӯз', 'فردا': 'фардо',
        'پریروز': 'парирӯз', 'پسفردا': 'пасфардо',
        'هفته': 'ҳафта', 'ماه': 'моҳ', 'سال': 'сол',
        'قرن': 'қарн', 'عصر': 'аср', 'دوره': 'давра',
        'لحظه': 'лаҳза', 'آن': 'он', 'ثانیه': 'сония',
        'دقیقه': 'дақиқа', 'ساعت': 'соат',
        'صبحانه': 'субҳона', 'ناهار': 'ноҳор', 'شام': 'шом',
        'همیشه': 'ҳамеша', 'گاهی': 'гоҳе', 'هرگاه': 'ҳаргоҳ',
    }

    # Частые префиксы
    PREFIXES = {
        'بی': 'бе', 'نا': 'но', 'می': 'ме', 'نمی': 'наме',
        'همی': 'ҳаме', 'در': 'дар', 'بر': 'бар',
        'فرا': 'фаро', 'فرو': 'фуру', 'باز': 'боз',
        'پیش': 'пеш', 'اندر': 'андар', 'برون': 'берун',
        'درون': 'дарун', 'فرود': 'фуруд', 'فراز': 'фароз',
    }

    # Частые суффиксы
    SUFFIXES = {
        'ها': 'ҳо', 'ان': 'он', 'ات': 'от', 'گان': 'гон',
        'یان': 'ён', 'ی': 'ӣ', 'گی': 'гӣ', 'ش': 'аш',
        'م': 'ам', 'ت': 'ат', 'ند': 'анд', 'ید': 'ед',
        'یم': 'ем', 'ست': 'аст', 'تر': 'тар', 'ترین': 'тарин',
        'مند': 'манд', 'ور': 'вар', 'گر': 'гар', 'گار': 'гор',
        'دان': 'дон', 'بان': 'бон', 'چه': 'ча', 'ک': 'ак',
        'انه': 'она', 'وار': 'вор', 'سار': 'сор', 'زار': 'зор',
    }

    def __init__(self, dictionary_path: Optional[str] = None):
        self.custom_dictionary = {}
        if dictionary_path:
            self._load_dictionary(dictionary_path)

    def _load_dictionary(self, path: str) -> None:
        try:
            with open(path, 'r', encoding='utf-8') as f:
                self.custom_dictionary = json.load(f)
        except FileNotFoundError:
            pass

    def transliterate(self, text: str) -> str:
        if not text:
            return ""
        text = self._normalize(text)
        tokens = self._tokenize(text)
        result = []
        for token in tokens:
            if self._is_persian_word(token):
                transliterated = self._transliterate_word(token)
                result.append(transliterated)
            else:
                result.append(token)
        return ''.join(result)

    def _normalize(self, text: str) -> str:
        replacements = {
            'ي': 'ی', 'ك': 'ک', 'ۀ': 'ه',
            '٠': '0', '١': '1', '٢': '2', '٣': '3', '٤': '4',
            '٥': '5', '٦': '6', '٧': '7', '٨': '8', '٩': '9',
            '۰': '0', '۱': '1', '۲': '2', '۳': '3', '۴': '4',
            '۵': '5', '۶': '6', '۷': '7', '۸': '8', '۹': '9',
            '\u200c': '', '\u200d': '',  # ZWNJ, ZWJ
            '‌': '', '‍': '',  # другие варианты
        }
        for old, new in replacements.items():
            text = text.replace(old, new)
        return text

    def _tokenize(self, text: str) -> list:
        pattern = r'([\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF]+|[^\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF]+)'
        return re.findall(pattern, text)

    def _is_persian_word(self, token: str) -> bool:
        return bool(re.match(r'^[\u0600-\u06FF\u0750-\u077F\uFB50-\uFDFF\uFE70-\uFEFF]+$', token))

    def _transliterate_word(self, word: str) -> str:
        # 1. Проверяем словари
        if word in self.custom_dictionary:
            return self.custom_dictionary[word]
        if word in self.WORD_DICTIONARY:
            return self.WORD_DICTIONARY[word]

        # 2. Пробуем разбить на префикс + корень
        for prefix_ar, prefix_tj in sorted(self.PREFIXES.items(), key=lambda x: -len(x[0])):
            if word.startswith(prefix_ar) and len(word) > len(prefix_ar):
                rest = word[len(prefix_ar):]
                if rest in self.WORD_DICTIONARY:
                    return prefix_tj + self.WORD_DICTIONARY[rest]
                # Рекурсивно проверяем остаток
                rest_trans = self._transliterate_word(rest)
                if rest_trans != self._apply_rules(rest):  # Если нашлось в словаре
                    return prefix_tj + rest_trans

        # 3. Пробуем разбить на корень + суффикс
        for suffix_ar, suffix_tj in sorted(self.SUFFIXES.items(), key=lambda x: -len(x[0])):
            if word.endswith(suffix_ar) and len(word) > len(suffix_ar):
                rest = word[:-len(suffix_ar)]
                if rest in self.WORD_DICTIONARY:
                    base = self.WORD_DICTIONARY[rest]
                    # Убираем конечную гласную если суффикс начинается с гласной
                    if base and base[-1] in self.VOWELS_SET and suffix_tj and suffix_tj[0] in self.VOWELS_SET:
                        base = base[:-1]
                    return base + suffix_tj

        # 4. Применяем правила транслитерации
        return self._apply_rules(word)

    def _apply_rules(self, word: str) -> str:
        result = []
        i = 0
        word_len = len(word)

        while i < word_len:
            char = word[i]
            next_char = word[i + 1] if i + 1 < word_len else ''
            next_next = word[i + 2] if i + 2 < word_len else ''
            prev_result = result[-1] if result else ''

            # Шадда (удвоение)
            if char == 'ّ' and result:
                last = result[-1]
                if last in self.CONSONANTS_SET:
                    result.append(last)
                i += 1
                continue

            # Диакритические знаки
            if char in self.DIACRITICS:
                result.append(self.DIACRITICS[char])
                i += 1
                continue

            # Алиф с мадда (آ)
            if char == 'آ':
                if i == 0:
                    result.append('о')
                else:
                    result.append('о')
                i += 1
                continue

            # Алиф (ا)
            if char == 'ا':
                if i == 0:
                    # В начале слова - проверяем следующую букву
                    if next_char == 'ی' or next_char == 'ي':
                        result.append('э')  # ای = э
                    elif next_char in self.CONSONANTS:
                        pass  # пропускаем, гласная определится позже
                    else:
                        result.append('а')
                elif prev_result in self.CONSONANTS_SET:
                    result.append('о')
                else:
                    result.append('а')
                i += 1
                continue

            # Вав (و)
            if char == 'و':
                if i == 0:
                    result.append('в')
                elif prev_result in self.CONSONANTS_SET:
                    # После согласной
                    if next_char and next_char in self.CONSONANTS:
                        result.append('у')
                    elif next_char == '' or next_char == 'ی':
                        result.append('у')
                    elif next_char == 'ا':
                        result.append('у')
                    else:
                        result.append('в')
                elif prev_result in self.VOWELS_SET:
                    result.append('в')
                else:
                    result.append('в')
                i += 1
                continue

            # Йа (ی/ي)
            if char in ('ی', 'ي'):
                if i == word_len - 1:
                    # В конце слова
                    if prev_result in self.CONSONANTS_SET:
                        result.append('ӣ')
                    else:
                        result.append('й')
                elif prev_result in self.CONSONANTS_SET:
                    result.append('и')
                elif i == 0:
                    result.append('й')
                else:
                    result.append('й')
                i += 1
                continue

            # Ха в конце слова (ه)
            if char == 'ه':
                if i == word_len - 1:
                    if prev_result in self.CONSONANTS_SET:
                        result.append('а')
                    elif prev_result in self.VOWELS_SET:
                        pass  # уже есть гласная
                    else:
                        result.append('а')
                else:
                    result.append('ҳ')
                i += 1
                continue

            # Айн (ع)
            if char == 'ع':
                if i == 0:
                    # В начале слова - чаще всего пропускается
                    if next_char in self.CONSONANTS:
                        result.append('а')  # добавляем гласную
                else:
                    result.append('ъ')
                i += 1
                continue

            # Обычные согласные
            if char in self.CONSONANTS:
                cyrillic = self.CONSONANTS[char]

                # Вставляем 'а' между двумя согласными
                if prev_result in self.CONSONANTS_SET and cyrillic in self.CONSONANTS_SET:
                    # Исключения - допустимые кластеры
                    skip_pairs = {
                        ('с', 'т'), ('ш', 'т'), ('х', 'т'), ('ф', 'т'),
                        ('н', 'д'), ('н', 'г'), ('р', 'д'), ('р', 'г'),
                        ('л', 'т'), ('л', 'д'), ('м', 'н'), ('р', 'ф'),
                        ('н', 'ҷ'), ('р', 'ҷ'), ('л', 'ф'), ('р', 'з'),
                        ('н', 'з'), ('р', 'с'), ('н', 'с'), ('р', 'ш'),
                        ('н', 'ш'), ('р', 'х'), ('н', 'х'), ('р', 'м'),
                        ('р', 'н'), ('л', 'м'), ('л', 'н'), ('р', 'к'),
                        ('н', 'к'), ('л', 'к'), ('с', 'к'), ('ш', 'к'),
                        ('р', 'б'), ('н', 'б'), ('л', 'б'), ('м', 'б'),
                        ('р', 'в'), ('н', 'в'), ('л', 'в'),
                    }
                    if (prev_result, cyrillic) not in skip_pairs:
                        result.append('а')

                result.append(cyrillic)
                i += 1
                continue

            # Неизвестный символ - оставляем
            result.append(char)
            i += 1

        return ''.join(result)

    def transliterate_poem(self, poem: str) -> str:
        lines = poem.split('\n')
        transliterated_lines = [self.transliterate(line) for line in lines]
        return '\n'.join(transliterated_lines)

    def add_to_dictionary(self, persian: str, tajik: str) -> None:
        self.custom_dictionary[persian] = tajik

    def save_dictionary(self, path: str) -> None:
        all_words = {**self.WORD_DICTIONARY, **self.custom_dictionary}
        with open(path, 'w', encoding='utf-8') as f:
            json.dump(all_words, f, ensure_ascii=False, indent=2)


def transliterate_text(text: str) -> str:
    transliterator = PersianToTajikTransliterator()
    return transliterator.transliterate(text)


if __name__ == "__main__":
    t = PersianToTajikTransliterator()
    examples = [
        "بوی جوی مولیان آید همی",
        "از خدا جوییم توفیق ادب",
        "دل من همچو مرغ بی پر است",
        "عشق آمد و شد خون جگرم",
        "می‌رود", "نمی‌شود", "خدا",
    ]
    print("Тест транслитератора v2:\n")
    for text in examples:
        result = t.transliterate(text)
        print(f"Вход:  {text}")
        print(f"Выход: {result}")
        print("-" * 40)
